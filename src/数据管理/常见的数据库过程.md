# 常见的数据库过程

Common Database Processes

## 归档（Archiving）

- 归档是将数据从可立即访问的存储介质移到检索性能较低的介质上的过程，存档可以被恢复到原始系统以供短期使用，不需要经常支持应用的数据应移动到较便宜的存储介质，从存档中恢复应该是简单地将数据从存档复制回系统的问题
- 归档过程必须与分区策略保持一致，以确保最佳的可用性和保留度（availability and retention）
- 确保可用性和保留度的稳妥做法
  - 创建次要（secondary）存储区域，最好在次要数据库服务器上
  - 将现有数据库表分区为归档块
  - 将不常用的数据复制到单独的数据库
  - 创建磁带或磁盘备份（tape or disk backups）
  - 创建定期清除不需要的数据的数据库作业
- 安排定期的存档恢复（restoration）测试以确保在紧急情况（emergency）下避免意外
- 当对生产系统的技术或结构进行更改时，需要评估以确保数据从存档移到当前存储是可读的
- 处理不同步存档（out-of-synch archives）的方法
  - 确定是否需要保留存档或需要保留多少存档，不需要的考虑清除
  - 对于重大技术变更，将档案恢复到技术变更前的原始系统，升级或迁移（upgrade or migrate）到新系统，并使用新技术重新归档数据
  - 对于源数据库结构发生变化的高价值存档，恢复存档，对数据结构进行更改，并使用新结构重新归档数据
  - 对与源数据库技术或结构发生变化的不常用存档，保持旧系统的小版本运行并限制访问，在需要时使用旧系统从存档中提取
- 当前技术无法恢复的存档是无用的，并且保留旧机器来读取无法以其他方式读取的存档，既不高效也不划算

## 容量和增长预测（Capacity and Growth Projections）

## 变动数据捕获（CDC，Change Data Capture）

- 变动数据捕获是检测数据已变动并确保与变动有关的信息已被适当存储的过程，CDC通常被称为基于日志的复制，其是一种非侵入性的方式（non-invasive way），可以在不影响源系统的情况下将数据变动复制到目标，一个系统的数据可能相较之间的时间点发生了变动，而第二个系统需要反映相同的变动，与其通过网络发送整个数据库来反映一些小的变化，不如只发送发生变动的内容（增量），以便接收系统可以进行适当的更新
- 检测和收集变动的方式
  - 数据版本控制，通过列标识已变动的行，如上次更新时间戳列、版本号列、状态列
  - 读取日志，其记录变动并使其能在次要系统中复制

## 清除（Purging）

- 清除是从存储介质完全删除数据以使其无法恢复的过程，数据管理的主要目标是维护数据的成本不应超过其对组织的价值
- 清除数据可以降低成本和风险，要清除的数据通常是过时的和不必要的，如果保存时间超过必要时间，某些数据可能会成为一种负担，清除数据可以降低其被滥用的风险

## 复制（Replication）

- 数据复制是指将相同的数据存储在多个存储设备上
- 在某些情况下，重复的数据库很有用，如高可用（high-availability）环境中，在不同硬件甚至数据中心的相同数据库之间分散工作负载可以在高峰使用时间或灾难时（peak usage times or  disasters）保留功能
- 复制的分类
  - 主动复制（Active replication）
    - 在每个副本上重新创建和存储来自其他副本的相同数据
  - 被动复制（Passive replication）
    - 在单个主副本（single primary replica）上重新创建和存储数据，然后将其结果状态（resultant state）转换（transform）到其他次要副本（secondary replicas）

- 复制的扩展维度（dimensions of scaling）
  - 水平数据扩展（Horizontal data scaling）
    - 有更多的数据副本
  - 垂直数据扩展（Vertical data scaling）
    - 副本在地理距离更远的位置上

- 多主机复制（Multi-master replication）可以将更新提交到任何数据库节点，然后扩散（ripple through）到其他服务器，但会增加复杂性和成本
- 当数据在数据库服务器间复制时会有复制透明性（），信息在整个数据库系统中保持一致，用户无法断定甚至无法知道在使用哪个副本

- 复制模式（replication patterns）
  - 日志传输（log shipping）
    - 次要服务器定期接收并应用主数据库的事务日志
  - 镜像（mirroring）
    - 作为两阶段提交过程（two-phase commit process）的一部分，对主数据的更新会立即（相对而言）复制到次要数据库

![](assets\常见的数据库过程\日志传输和镜像.jpg)

- 复制方法的选择取决于数据的重要性，以及立即故障转移（failover）到次要服务器的重要性，镜像方式通常比日志传送更昂贵，对于一台次要服务器，镜像方式是有效的，日志传输可用于更新额外的次要服务器

## 弹性和恢复（Resiliency and Recovery）

- 数据库的弹性是亨利系统对错误情况的容忍程度的指标，如果一个系统可以容忍高水平的处理错误并仍然按预期允许，则其具备很高的弹性，如果应用程序在第一个意外情况下崩溃，则其不具备弹性，如果数据库可以检测并终止或自动从常见的处理错误（如失控查询）中恢复，则其被认为是有弹性的，系统无法提前检测到的情况，如电源故障，被认为是灾难
- 恢复的类型
  - 立即恢复（Immediate recovery）
    - 某些问题的立即恢复有时可以通过设计解决，如预测并自动解决可能由故障转移到备份系统引起的问题
  - 关键恢复（Critical recovery）
    - 尽快恢复系统以最大程度地减少业务流程的延迟或关闭
  - 非关键恢复（Non-critical recovery）
    - 功能的恢复可以延迟直到更关键的系统已经恢复
- 数据处理错误包括数据加载失败、查询返回失败以及完成ETL或其他过程的障碍（data load failures, query return failures, and obstacles to completing ETL or other processes）
- 常见的提高数据处理系统弹性方法有捕获并重新发送（trap and re-route）导致错误的数据，检测并忽略（detect and ignore）导致错误的数据，并在处理完成的步骤中添加标志以编码在重启进程时重新处理数据或重复已完成的步骤
- 每个系统都需要一定程度的弹性（高或低），一些应用程序可能要求任何错误都停止所有处理，而其他应用程序可能只需要捕获错误并重新发送以供审查
- 对于及其关键的数据，数据库管理员需要实施复制模式，数据移动到远程服务器上的另一个数据库副本，如果数据库出现故障，应用程序可以故障转移到远程数据库并继续处理

## 保留（Retention）

- 数据保留指数据保持可用的时间，数据保留规划应该是物理数据库设计的一部分，保留需要也会影响容量规划
- 数据安全也会影响数据保留规划，因为某些数据出于法律原因需要在特定时间范围内保留，未能将数据保留适当的时间程度可能会产生法律后果，同样也有清除数据的相关规定，如果保存时间超过指定时间，数据可能会称为一种负担（liability），组织应根据监管要求和风险管理指南制定保留策略，并通过保留策略推动数据清除和归档的规范

## 分片（Sharding）

- 分片是将数据库分成的小块进行隔离并可独立于其他分片进行更新的过程，因此复制只是一个文件副本，因为分片很小，所以刷新/覆盖可能是最佳选择
  - Sharding is a process where small chunks of the database are isolated and can be updated independently of other shards, so replication is merely a file copy.